# SENDGRID API

## **Backgroud**
**SendGrid** is a powerful email delivery service provider. You can send transactional emails as well as marketing emails using SendGrid. 

**Transactional emails** are more of a personalized emails, such as, password reset email, order confirmation email, account verification emails etc. The main theme here is that it addresses the user/receiver directly. 

On the other hand, **Marketing emails** are targeted to mass audience. Examples include, discount offer emails from e-commerce websites or learning websites.

## **What is needed to use SendGrid**

To send emails using SendGrid, you need to
- Setup an account ([Website](https://signup.sendgrid.com/))
- Verify your domain ([More on this](https://docs.sendgrid.com/ui/account-and-settings/how-to-set-up-domain-authentication))
- Generate API key ([Link](https://app.sendgrid.com/settings/api_keys))

You can sign up for free. Free account allows you to send 100 emails per month, which i believe is prtty fair number of email. ([More on pricing](https://sendgrid.com/pricing/))

## **What do we use &amp; why**
We bsaically use transactional email API to send:

- Email address verification emails
- Password reset emails
- Reminder emails
- Statistics emails

The reason we use Transaction Email API is because it is more reliable when sending emails to multple users (more than 50 users) and SendGrid tracks &amp; takes care if an email was unable to send. SendGrid also keeps a log of each email.


## **More on Transactional Emails**

**Transactional emails** can be sent in 2 ways using SendGrid API.
- Method 1: You provide the text or html code (more like a DIY approach) or
- Method 2: You design the email directly in SendGrid using [Dynamic Templates](https://mc.sendgrid.com/dynamic-templates)

#### **Method 1**: This method is applicable if you want to send a simple email, which does not contain any image or any kind of design. Or if the email contains some kind of design and images, but you already have the design and image(s) coded in HTML. In this case, use the following code:
```javascript 
// using Twilio SendGrid's v3 Node.js Library
// https://github.com/sendgrid/sendgrid-nodejs
const sgMail = require('@sendgrid/mail');
sgMail.setApiKey(process.env.SENDGRID_API_KEY);
const msg = {
  to: 'test@example.com',
  from: 'test@example.com',
  subject: 'Sending with Twilio SendGrid is Fun',
  text: 'and easy to do anywhere, even with Node.js',
  html: '<strong>and easy to do anywhere, even with Node.js</strong>',
};
sgMail
.send(msg)
.then(() => {
    console.log('Mail sent');
}, error => {
    console.log(error.response);
    console.error(error);
    if (error.response) {
        console.error(error.response.body)
    }
});
```

#### **Method 2 (Dynamic Templates)**: In this method, you don't need to write any html code. You can simply drag and drop components (similar to any no code websites), and create a template. In the template, you can even declare placeholders. Once you create a template, SendGrid generates a template-id. You need to pass the template-id when sending any email. In this case, use the following code:
```javascript 
// using Twilio SendGrid's v3 Node.js Library
// https://github.com/sendgrid/sendgrid-nodejs
const sgMail = require('@sendgrid/mail');
sgMail.setApiKey(process.env.SENDGRID_API_KEY);

const msg = {
    "personalizations": [
        {
            //"to" can be an array of JSON objects with email as a key for each object 
            // or 
            //"to" can be an email address as shown in Method 1 
            "to": [
                {"email": "user1@gmail.com"},
                {"email": "user2@gmail.com"}
            ],
            // Similar to "to", "cc" can be an array of object or just one email address
            "cc": [
                {"email": "ch@tdrl.com"},
                {"email": "md@tdrl.com"}
            ],
            // dynamic_template_data mainly contains any data you want to pass into the template, 
            // provided that the template  already has placeholder for the data.
            "dynamic_template_data": {
                "username": "myusername",
                "full_name": "The Dot Red Limited"
            }
        }
    ],
    "from": {
        "email": 'info@thedotred.com',
        "name": 'The Dot Red Limited'
    },
    "attachments": [],
    // template_id is the id which is generated by SendGrid when a template is created.
    "template_id": 'd-13ac633472ff49deab34104ce4fd9e88'
};
sgMail
.send(msg)
.then(() => {
    console.log('Mail sent');
}, error => {
    console.log(error.response);
    console.error(error);
    if (error.response) {
        console.error(error.response.body)
    }
});
```

## **How we send emails in TDRL using SendGrid**


> ### **1. Setup Transactional Emails Settings**
As we use nodemon, hence i believe `nodemon.json` already exists in your project. If your project does not have `nodemon.json` file, then i would suggest you to create a `nodemon.json` file in the root directory of your project. In the nodemon.json file, add the following 3 keys. 
 - SENDGRID_API_KEY
 - APP_EMAIL
 - APP_EMAIL_TITLE

`SENDGRID_API_KEY` is the API key generated from SendGrid account. You can use yours or get the key from our ERP.

`APP_EMAIL` is the email address you registered during domain verification. In our case, it should be info@thedotred.com.

`APP_EMAIL_TITLE` is the name to be shown to the recipient.

> ### **2. Code Snippet**

Once the above keys and values are added to the `nodemon.json` file, then create a `sendgrid.js` file in utils folder. If utils folder does not exists in the root directory of your project, then create one. In the sendgrid.js file, paste the following code snippet. The code includes one function which can be used both plain/html coded email and dynamic template email.

The following code snippet is designed in such a way so that wherever an email needs to be sent, you can simply import the file and use the function.

```javascript 
// using Twilio SendGrid's v3 Node.js Library
// https://github.com/sendgrid/sendgrid-nodejs
const sgMail = require('@sendgrid/mail');
sgMail.setApiKey(process.env.SENDGRID_API_KEY);
/**
 * This function can send both plain/html coded email and dynamic template email. If you want to send plain/html coded email, then pass templateID as null. 
 * @param {(string|object[])} to - Either one single email address or array of objects with 'email' key and the email address as a value 
 * @param {(null|object)} templateContents - Object containing data for template placeholders.
 * @param {(null|string)} templateID - Template ID generated by SendGrid.
 * @param {array} [attachment=[]] - List of Attachments.
 * @param {(string|object[])} [cc=[]] - Either one single email address or array of objects with 'email' key and the email address as a value
 * @param {string} subject - Subject is any text and it is needed when sending plain/html coded email.
 * @param {string} content - Subject is plain text/html coded email body.
 */
function sendEmail(to, templateContents, templateID , attachments, cc, subject, content){
    /* Parameter formats
        "to" & "cc" are array of JSON objects or simple string
        "templateContents" is JSON object
        "subject" is string
        "templateID" is string
        to: [
            {"email": "user1@gmail.com"},
            {"email": "user2@gmail.com"}
        ]

        "dynamic_template_data": {
            "username": "myusername",
            "full_name": "The Dot Red Limited"
        }

        attachments: [
            {
                content: attachment,
                filename: "attachment.pdf",
                type: "application/pdf",
                disposition: "attachment"
            }
        ]
     */

    let msg = {};
    // Checks if attachment is passed as null. If so, then sets empty array as default.
    if (!attachment) attachment = [];
    
    // Checks if cc is passed as null. If so, then sets empty array as default.
    if (!cc) cc = [];

    if (templateID){
        msg = {
            "personalizations": [
                {
                  "to": to,
                  "cc": cc,
                  "dynamic_template_data": templateContents
                }
              ],
              "from": {
                "email": "info@thedotred.com",
                "name": "DOT RED SUPPORT"
              },
              "attachments": attachments,
              "template_id": templateID      
        }
        msg.template_id = templateID;
    } else {
        msg = {
            to: to,
            // Use the email address or domain you verified
            "from": {
                "email": "info@thedotred.com",
                "name": "DOT RED SUPPORT"
            },
            subject: subject,
            "attachments": attachments,
            html: content
        }
    }
    // Finally send the email
    sgMail
    .send(msg)
    .then(() => {
        console.log('Mail sent');
    }, error => {
        console.log(error.response);
        console.error(error);
        if (error.response) {
            console.error(error.response.body)
        }
    });
};

module.exports = { sendEmail };
```